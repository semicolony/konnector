#!/usr/bin/env python3


import sys
import subprocess
import requests
import json
import time
import shlex


URL = 'https://api.digitalocean.com/v2/droplets'
TOKENFILE = '/Users/Paul/Projects/secrets/dotoken'
with open(TOKENFILE, 'r') as f:
    TOKEN = f.readline().strip()
REGIONS = ['nyc1', 'nyc3', 'sfo3', 'ams3', 'sgp1', 'lon1', 'fra1', 'tor1', 'blr1']
HEADERS = {
    'Authorization': f"Bearer {TOKEN}",
    'Content-type': 'application/json'
}


def err_exit(code,msg,*args):
    print(f"Error in: {__name__}")
    print(f"{msg}")
    if len(args) != 0:
        if args is dict:
            for k,v in args.items():
                print(f"{k}: {v}")
        else:
            args = ' '.join(args)
            print(f"Exception: {args}")
    exit(code)


def create_droplet(name,region):
    print(f"Creating droplet...\nName -> {name}\nRegion -> {region}")
    data = {
        'name': name,
        'region': region,
        'size': 's-2vcpu-4gb',
        'image': 'kuyio-wireguardianvpna',
        'ssh_keys': ['3a:bf:bb:3d:2a:31:94:89:44:ef:fa:2c:6f:cd:ef:ac']
    }
    r = requests.post(URL, headers=HEADERS, json=data)
    response = json.loads(r.content.decode('utf-8'))
    if not r.status_code == 202:
        err_exit(1,f"Creation of {name} failed",f"{response}")
    droplet_id = response['droplet']['id']
    print(f"Waiting for the droplet {droplet_id} to be created...")
    time.sleep(15)
    return droplet_id


def get_public_ipv4(droplet_id):
    cmd = ['doctl', 'compute', 'droplet', 'get', droplet_id, '--format', 'PublicIPv4', '--no-header']
    try:
        output = subprocess.run(cmd, capture_output=True, text=True)
    except Exception as err:
        err_exit(1,f"{' '.join(cmd)} failed", f"{err}")
    return output.stdout


def start_konnect(name,droplet_ip):
    print(f"Waiting for {name} -> {droplet_ip} to be reachable...")
    time.sleep(120)
    print('Starting konnect...')
    cmd = shlex.split(f'ssh -i /Users/Paul/.ssh/cloud_rsa -o StrictHostKeyChecking=no root@{droplet_ip} "cd /opt/konnect; echo starting konnect service; docker-compose up -d"')
    try:
        output = subprocess.run(cmd, capture_output=True, text=True)
        print(output.stdout)
    except Exception as err:
        err_exit(2,f"{' '.join(cmd)} failed", f"{err}")
    time.sleep(10)
    print('Getting your token...')
    time.sleep(10)
    cmd = shlex.split(f'''ssh -i /Users/Paul/.ssh/cloud_rsa -o StrictHostKeyChecking=no root@{droplet_ip} "cd /opt/konnect; docker-compose logs | grep "token" | awk '{{print $14}}'"''')
    try:
        output = subprocess.run(cmd, capture_output=True, text=True)
        konnecttoken = output.stdout
    except Exception as err:
        err_exit(2,f"{' '.join(cmd)} failed", f"{err}")
    print(f"\nToken to validate http://{droplet_ip} -> {konnecttoken}\n")


def main():
    name = sys.argv[1]
    if sys.argv[2] in REGIONS:
        region = sys.argv[2]
    else:
        err_exit(1,"Region invalid",f"Valid regions are: {' '.join(REGIONS)}")
    droplet_id = str(create_droplet(name,region))
    droplet_ip = (get_public_ipv4(droplet_id)).strip()
    start_konnect(name,droplet_ip)


if __name__ == '__main__':
    main()
